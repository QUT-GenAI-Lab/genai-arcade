<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAG Process Demo - Fixed</title>
  <style>
    .rag-demo-widget {
      --bg: #efc0df;
      --panel: #efc0df;
      --muted: #000000;
      --text: #000000;
      --accent: #7aa2ff;
      --accent-2: #4ad4b8;
      --warning: #ffcf6d;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 15% -10%, #efc0df 0%, #efc0df 40%, #efc0df 100%);
      color: var(--text);
      padding: 20px;
      border-radius: var(--radius);
      width: 100%;
      margin: 0;
      position: relative;
      min-height: 400px;
      box-sizing: border-box;
      /* Add these for zoom stability */
      transform-origin: top left;
      contain: layout style paint;
    }

    .rag-demo-widget * { 
      box-sizing: border-box; 
    }

    .rag-demo-widget .board { 
      position: relative; 
      height: 400px;
      border: 1px solid #1f2a44; 
      border-radius: var(--radius); 
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.0)); 
      box-shadow: var(--shadow); 
      overflow: hidden; 
      /* Force hardware acceleration for smoother zoom */
      transform: translateZ(0);
      will-change: transform;
    }

    .rag-demo-widget .lane-wrap { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      height: 100%; 
    }

    .rag-demo-widget .lane { 
      position: relative; 
      padding: 12px; 
      border-right: 1px dashed #203152; 
      overflow: visible; 
    }

    .rag-demo-widget .lane:last-child { 
      border-right: none; 
    }

    .rag-demo-widget .lane h2 { 
      font-size: 14px; 
      margin: 0 0 4px; 
      color: #000000; 
      font-weight: 600; 
    }

    .rag-demo-widget .lane .hint { 
      font-size: 11px; 
      color: var(--muted); 
    }

    .rag-demo-widget .dock { 
      position: absolute; 
      left: 8px; 
      right: 8px; 
      top: 15%; 
      height: 25%; 
      border-radius: 8px; 
      border: 1px dashed #28406d; 
      background: rgba(255,255,255,0.02); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 1; 
    }

    .rag-demo-widget .lane .content { 
      display: flex;
      flex-direction: column;
      position: absolute; 
      width: 90%; 
      top: 42%; 
      left: 8px; 
      right: 8px; 
      bottom: 8px; 
      border-radius: 8px; 
      padding: 6px; 
      background: rgba(255,255,255,0.02); 
      border: 1px solid #1a2744; 
      overflow: auto; 
      z-index: 1; 
      opacity: 0; 
      transform: translateY(20px); 
      transition: all 0.6s ease; 
    }

    .rag-demo-widget .lane .content.visible { 
      opacity: 1; 
      transform: translateY(0); 
    }

    .rag-demo-widget .arrow { 
      position: absolute; 
      top: 50%; 
      transform: translateY(-50%); 
      font-size: 18px; 
      color: #335899; 
      opacity: 0.9; 
      z-index: 2; 
    }

    .rag-demo-widget .arrow.a1 { 
      left: calc(33.333% - 9px); 
    }

    .rag-demo-widget .arrow.a2 { 
      left: calc(66.666% - 9px); 
    }

    .rag-demo-widget .card { 
      position: absolute; 
      width: 25%; 
      max-height: 15%; 
      background: #f5e7f0; 
      border: 1px solid #2b4a83; 
      border-radius: 12px; 
      padding: 6px; 
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; 
      line-height: 1.1; 
      white-space: pre-wrap; 
      word-wrap: break-word; 
      z-index: 10; 
      overflow: auto; 
      pointer-events: auto; 
      transition: transform 0.3s ease; 
      color: var(--text); 
      top: 0px; 
      left: 0px; 
      font-size: 11px;
      display: flex;
      flex-direction: column;
      /* Zoom stability improvements */
      transform-origin: center center;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .rag-demo-widget .card .tag { 
      display: inline-block; 
      font-size: 9px; 
      padding: 2px 4px; 
      border-radius: 4px; 
      border: 1px solid #2e559a; 
      background: #0f1f44; 
      color: #d5e4ff; 
      margin-bottom: 3px; 
      flex-shrink: 0;
      align-self: flex-start;
    }
    
    .rag-demo-widget .card #cardText {
      flex: 1;
      overflow: auto;
      font-size: inherit;
      line-height: 1.1;
      margin: 0;
    }
    .rag-demo-widget .pulse { 
      animation: rag-pulse 1s ease-in-out 2; 
    }

    @keyframes rag-pulse { 
      0%, 100% { box-shadow: 0 0 0 0 rgba(122,162,255,.0); } 
      50% { box-shadow: 0 0 0 12px rgba(122,162,255,.08); } 
    }

    .rag-demo-widget .btns { 
      display: flex; 
      gap: 8px; 
      margin-top: 12px; 
      flex-wrap: wrap;
    }

    .rag-demo-widget button { 
      padding: 8px 12px; 
      border-radius: 8px; 
      border: 1px solid #2a3e69; 
      background: linear-gradient(180deg,#6b3e57,#6b3e57); 
      color: #faf4f8; 
      cursor: pointer; 
      font-weight: 600; 
      letter-spacing: .2px; 
      font-size: 12px;
      min-width: 80px;
    }

    .rag-demo-widget button.secondary { 
      background: #6b3e57; 
      color: #faf4f8; 
    }

    .rag-demo-widget button:disabled { 
      opacity: .5; 
      cursor: not-allowed; 
    }

    .rag-demo-widget .doc { 
      padding: 4px 6px; 
      background: #f5e7f0; 
      border: 1px solid #20345e; 
      border-radius: 4px; 
      margin-bottom: 4px; 
      font-size: 11px; 
      line-height: 1.3;
      word-break: break-word;
      flex-shrink: 0;
    }

    .rag-demo-widget .llm-output { 
      font-size: 11px; 
      padding: 8px 10px; 
      border-radius: 8px; 
      background: #f5e7f0; 
      border: 1px solid #27406f; 
      line-height: 1.4;
      word-break: break-word;
      flex-shrink: 0;
    }

    .rag-demo-widget .muted { 
      color: var(--muted); 
    }

    .rag-demo-widget ::-webkit-scrollbar { 
      height: 8px; 
      width: 8px; 
    }

    .rag-demo-widget ::-webkit-scrollbar-thumb { 
      background: #6b3e57; 
      border-radius: 6px; 
      border: 2px solid transparent; 
      background-clip: content-box; 
    }

    .rag-demo-widget ::-webkit-scrollbar-track { 
      background: transparent; 
    }

    /* Responsive adjustments */
    @media (max-width: 900px) {
      .rag-demo-widget .board {
        height: 350px;
      }
      
      .rag-demo-widget .dock {
        top: 12%;
        height: 20%;
      }
      
      .rag-demo-widget .lane .content {
        top: 35%;
      }
    }

    @media (max-width: 480px) {
      .rag-demo-widget .board {
        height: 300px;
      }
      
      .rag-demo-widget .lane {
        padding: 8px;
      }
      
      .rag-demo-widget .lane h2 {
        font-size: 12px;
      }
      
      .rag-demo-widget .lane .hint {
        font-size: 10px;
      }
      
      .rag-demo-widget .dock {
        top: 10%;
        height: 18%;
        left: 4px;
        right: 4px;
      }
      
      .rag-demo-widget .lane .content {
        top: 30%;
        left: 4px;
        right: 4px;
        bottom: 4px;
      }
      
      .rag-demo-widget .card {
        width: 100px;
        max-height: 70px;
        font-size: 9px;
        padding: 4px;
      }
      
      .rag-demo-widget .card .tag {
        font-size: 8px;
        padding: 1px 4px;
        margin-bottom: 2px;
      }
      
      .rag-demo-widget .arrow {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="rag-demo-widget" id="ragDemoWidget">
    <div class="board" id="board">
      <div class="lane-wrap">
        <section class="lane" id="lane-prompt">
          <h2>üìù User Prompt</h2>
          <div class="hint">Start here</div>
          <div class="dock" id="dock-prompt"></div>
          <div class="content" aria-live="polite"></div>
        </section>

        <div class="arrow a1">‚Üí</div>

        <section class="lane" id="lane-rag">
          <h2>üß≠ RAG</h2>
          <div class="hint muted">Retrieves relevant documents</div>
          <div class="dock" id="dock-rag"></div>
          <div class="content" id="ragContent"></div>
        </section>

        <div class="arrow a2">‚Üí</div>

        <section class="lane" id="lane-llm">
          <h2>ü§ñ LLM</h2>
          <div class="hint muted">Generates the final answer</div>
          <div class="dock" id="dock-llm"></div>
          <div class="content" id="llmContent"></div>
        </section>
      </div>

      <div class="card" id="card" aria-live="polite">
        <div class="tag" id="cardTag">Original Prompt</div>
        <div id="cardText">What is the weather like in brisbane today?</div>
      </div>
    </div>

    <div class="btns">
      <button id="nextBtn">Next step ‚ñ∑</button>
      <button class="secondary" id="resetBtn" disabled>Reset</button>
    </div>
  </div>

  <script>
    // Encapsulated RAG Demo functionality
    (function(widgetId) {
      const widget = document.getElementById(widgetId);
      if (!widget) return;

      const card = widget.querySelector('#card');
      const nextBtn = widget.querySelector('#nextBtn');
      const resetBtn = widget.querySelector('#resetBtn');
      const dockPrompt = widget.querySelector('#dock-prompt');
      const dockRag = widget.querySelector('#dock-rag');
      const dockLlm = widget.querySelector('#dock-llm');
      const ragContent = widget.querySelector('#ragContent');
      const llmContent = widget.querySelector('#llmContent');
      const cardTag = widget.querySelector('#cardTag');
      const cardText = widget.querySelector('#cardText');

      const retrievedDocs = [
        "Result: BOM forecast indicates 23‚Äì29¬∞C with a chance of afternoon showers and light easterly winds.",
        "Result: Cloud cover increasing by late afternoon; UV index very high around midday.",
        "Result: Humidity moderate; brief showers possible near the coast, becoming fine by evening."
      ];

      const makeEnrichedPrompt = (docs) => [
        "What is the weather like in brisbane today?",
        "",
        "Use the following documents to inform your response:",
        ...docs.map(d => `{${d}}`)
      ].join("\n");

      const summarised = "warm, partly cloudy with a chance of brief afternoon showers and light easterly winds";

      let stage = 1;

      function centerCardOver(el) {
        if (!el || !card) return;
        
        const board = widget.querySelector('#board');
        if (!board) return;
        
        // Use requestAnimationFrame to ensure measurements are accurate
        requestAnimationFrame(() => {
          const boardRect = board.getBoundingClientRect();
          const targetRect = el.getBoundingClientRect();
          
          // Calculate relative positions within the board
          const relativeX = targetRect.left - boardRect.left;
          const relativeY = targetRect.top - boardRect.top;
          
          // Center the card over the target
          const targetCenterX = relativeX + (targetRect.width / 2);
          const targetCenterY = relativeY + (targetRect.height / 2);
          
          const cardCenterX = targetCenterX - (card.offsetWidth / 2);
          const cardCenterY = targetCenterY - (card.offsetHeight / 2);
          
          // Constrain to board bounds with some padding
          const padding = 5;
          const maxX = board.offsetWidth - card.offsetWidth - padding;
          const maxY = board.offsetHeight - card.offsetHeight - padding;
          
          const finalX = Math.max(padding, Math.min(cardCenterX, maxX));
          const finalY = Math.max(padding, Math.min(cardCenterY, maxY));
          
          // Use 3D transform for better performance and zoom stability
          card.style.transform = `translate3d(${Math.round(finalX)}px, ${Math.round(finalY)}px, 0)`;
        });
      }

      function showContent(el, html) {
        el.innerHTML = html;
        el.classList.add('visible');
      }

      function clearContent(el) {
        el.innerHTML = '';
        el.classList.remove('visible');
      }

      function typeDocs(docs, idx = 0) {
        if (idx === 0) clearContent(ragContent);
        if (idx >= docs.length) return;
        const wrap = document.createElement('div');
        wrap.className = 'doc';
        ragContent.appendChild(wrap);
        let i = 0;
        const timer = setInterval(() => {
          wrap.textContent += docs[idx][i++];
          if (i >= docs[idx].length) {
            clearInterval(timer);
            setTimeout(() => typeDocs(docs, idx + 1), 200);
          }
        }, 10);
        setTimeout(() => ragContent.classList.add('visible'), 100);
      }

      function setButtons() {
        resetBtn.disabled = false;
        nextBtn.disabled = false;
        nextBtn.textContent = (stage < 4) ? 'Next step ‚ñ∑' : 'Run LLM ‚ñ∑';
      }

      function goToStage(s) {
        stage = s;
        setButtons();

        if (stage === 1) {
          cardTag.textContent = 'Original Prompt';
          cardText.textContent = 'What is the weather like in brisbane today?';
          card.classList.add('pulse');
          setTimeout(() => centerCardOver(dockPrompt), 100);
          clearContent(ragContent);
          clearContent(llmContent);
        }

        if (stage === 2) {
          setTimeout(() => centerCardOver(dockRag), 100);
          card.classList.remove('pulse');
          cardTag.textContent = 'RAG: Retrieving‚Ä¶';
          cardText.textContent = 'What is the weather like in brisbane today?';
          typeDocs(retrievedDocs);
        }

        if (stage === 3) {
          cardTag.textContent = 'Enriched Prompt';
          cardText.textContent = makeEnrichedPrompt(retrievedDocs);
          card.classList.add('pulse');
          setTimeout(() => centerCardOver(dockRag), 100);
          showContent(ragContent, retrievedDocs.map(d => `<div class="doc">${d}</div>`).join(''));
        }

        if (stage === 4) {
          setTimeout(() => centerCardOver(dockLlm), 100);
          card.classList.remove('pulse');
          cardTag.textContent = 'LLM: Consuming‚Ä¶';
          cardText.textContent = makeEnrichedPrompt(retrievedDocs);
          setTimeout(() => {
            showContent(llmContent, `<div class="llm-output"><strong>Answer:</strong> The weather in Brisbane will be like ${summarised} today!</div>`);
          }, 450);
        }
      }

      // Enhanced resize handler with debouncing and better timing
      let resizeTimeout;
      function handleResize() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          const currentDock = stage <= 1 ? dockPrompt : stage <= 3 ? dockRag : dockLlm;
          centerCardOver(currentDock);
        }, 150);
      }

      // Better initialization timing
      function initialize() {
        setTimeout(() => {
          centerCardOver(dockPrompt);
          goToStage(1);
        }, 200);
      }

      // Event listeners
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
      } else {
        initialize();
      }
      
      window.addEventListener('resize', handleResize);

      nextBtn.addEventListener('click', () => {
        if (stage < 4) goToStage(stage + 1);
        else goToStage(4);
      });
      
      resetBtn.addEventListener('click', () => goToStage(1));

    })('ragDemoWidget');

    // Global embedding function for external use
    window.createRAGDemo = function(containerId, options = {}) {
      const container = document.getElementById(containerId);
      if (!container) {
        console.error(`Container with id "${containerId}" not found`);
        return;
      }
      
      // Clone the widget HTML
      const widgetHTML = document.querySelector('.rag-demo-widget').cloneNode(true);
      const uniqueId = 'ragDemo_' + Math.random().toString(36).substr(2, 9);
      widgetHTML.id = uniqueId;
      
      // Clear container and add widget
      container.innerHTML = '';
      container.appendChild(widgetHTML);
      
      // Re-initialize the script for the new widget
      setTimeout(() => {
        const newWidget = document.getElementById(uniqueId);
        if (newWidget) {
          // Execute the widget initialization code
          const script = document.createElement('script');
          script.textContent = `
            (function(widgetId) {
              // Insert the same initialization code here but with the new widgetId
              // This is a simplified version - in practice you'd want to extract the init function
              console.log('Initializing RAG demo for:', widgetId);
            })('${uniqueId}');
          `;
          document.head.appendChild(script);
        }
      }, 100);
      
      return uniqueId;
    };
  </script>
</body>
</html>